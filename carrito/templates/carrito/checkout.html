from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from carrito.models import Pedido, ItemPedido
from pages.models import Vino
from django.contrib.auth.models import User
from messenger.models import Mensaje  # Si us√°s mensajer√≠a interna

@login_required
def checkout(request):
    carrito = request.session.get('carrito', {})

    if request.method == 'POST':
        if not carrito:
            messages.warning(request, "Tu carrito est√° vac√≠o.")
            return redirect('carrito:ver')

        pedido = Pedido.objects.create(usuario=request.user, total=0)
        total = 0

        for slug, item in carrito.items():
            vino = get_object_or_404(Vino, slug=slug)
            cantidad = item['cantidad']
            precio_unitario = vino.precio
            subtotal = cantidad * precio_unitario

            ItemPedido.objects.create(
                pedido=pedido,
                producto=vino,
                cantidad=cantidad,
                precio_unitario=precio_unitario
            )

            total += subtotal

        pedido.total = total
        pedido.save()
        request.session['carrito'] = {}

        # Mensaje interno de confirmaci√≥n
        sistema = User.objects.filter(is_superuser=True).first()
        if sistema:
            Mensaje.objects.create(
                emisor=sistema,
                receptor=request.user,
                asunto="üßæ Confirmaci√≥n de pedido",
                cuerpo=f"""
Hola {request.user.username},

Tu pedido #{pedido.id} fue confirmado con √©xito el {pedido.creado_en.strftime('%d/%m/%Y %H:%M')}.
Total: ${pedido.total}

Gracias por confiar en nuestra experiencia sensorial.
""".strip()
            )

        messages.success(request, "‚úÖ Pedido confirmado con √©xito.")
        return redirect('pages:vino_list')

    # Si es GET, mostrar el resumen
    items = []
    total = 0
    for slug, item in carrito.items():
        vino = get_object_or_404(Vino, slug=slug)
        cantidad = item['cantidad']
        subtotal = vino.precio * cantidad
        total += subtotal
        items.append({
            'vino': vino,
            'cantidad': cantidad,
            'subtotal': subtotal
        })

    return render(request, 'carrito/checkout.html', {
        'items': items,
        'total': total
    })